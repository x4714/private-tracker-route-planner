<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TrackersInfo Official Recruitments</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #0a0a0a;
      color: #e0e0e0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }

    a {
      color: #60a5fa;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    #settingsMenu {
      display: none;
      position: absolute;
      top: 10px;
      right: 50px;
      background: #1a1a1a;
      border: 1px solid #333;
      font-size: 13px;
      color: #e0e0e0;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }

    #settingsMenu .setting {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }

    #settingsMenu .setting:last-child {
      margin-bottom: 0;
    }

    #settingsMenu .setting label {
      width: 90px;
      font-weight: 500;
      color: #b0b0b0;
    }

    #settingsMenu .setting input,
    #settingsMenu .setting select {
      flex: 1;
      padding: 6px 8px;
      width: 140px;
      border: 1px solid #444;
      border-radius: 4px;
      background: #2a2a2a;
      color: #e0e0e0;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 13px;
    }

    #settingsToggle {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #2a2a2a;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 18px;
      cursor: pointer;
      color: #e0e0e0;
      z-index: 1001;
    }

    #settingsToggle:hover {
      background: #333;
    }

    #routeContainer {
      position: relative;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      box-sizing: border-box;
      overflow: hidden;
      background: #0a0a0a;
      user-select: none;
    }

    #calcForm {
      position: relative;
      display: block;
      color: #e0e0e0;
      background: transparent;
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    #headerSection {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      gap: 20px;
    }

    .tracker-selector {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 15px 20px;
      cursor: pointer;
      transition: all 0.2s;
      flex: 1;
      max-width: 300px;
    }

    .tracker-selector:hover {
      background: #222;
      border-color: #444;
    }

    .tracker-label {
      font-size: 11px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 5px;
    }

    .tracker-name {
      font-size: 18px;
      font-weight: 600;
      color: #e0e0e0;
    }

    .tracker-abbr {
      font-size: 12px;
      color: #999;
      margin-top: 3px;
    }

    .nav-arrows {
      display: flex;
      gap: 10px;
    }

    .nav-arrow {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 15px 20px;
      font-size: 24px;
      cursor: pointer;
      color: #e0e0e0;
      transition: all 0.2s;
      font-weight: 600;
    }

    .nav-arrow:hover {
      background: #222;
      transform: translateY(-2px);
    }

    #routeChain {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 15px 20px;
      font-size: 16px;
      font-weight: 500;
      text-align: center;
      margin-bottom: 15px;
      color: #60a5fa;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #chainInfo {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 12px 20px;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      color: #b0b0b0;
    }

    #detailsTable {
      overflow-y: auto;
      max-height: calc(100vh - 300px);
      scrollbar-width: thin;
      scrollbar-color: #333 #1a1a1a;
    }

    #detailsTable::-webkit-scrollbar {
      width: 8px;
    }

    #detailsTable::-webkit-scrollbar-track {
      background: #1a1a1a;
    }

    #detailsTable::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 4px;
    }

    .route-step {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 15px 20px;
      margin-bottom: 10px;
    }

    .route-step-header {
      font-size: 15px;
      font-weight: 600;
      color: #e0e0e0;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
    }

    .route-step-days {
      color: #60a5fa;
    }

    .route-step-row {
      display: flex;
      padding: 6px 0;
      border-bottom: 1px solid #252525;
    }

    .route-step-row:last-child {
      border-bottom: none;
    }

    .route-step-label {
      width: 180px;
      color: #888;
      font-size: 13px;
    }

    .route-step-value {
      flex: 1;
      color: #e0e0e0;
      font-size: 13px;
    }

    #gridContainer {
      display: none;
      position: fixed;
      width: 90vw;
      max-width: 800px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-height: 70vh;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      overflow-y: auto;
      z-index: 10000;
      scrollbar-width: thin;
      scrollbar-color: #333 #1a1a1a;
    }

    #gridContainer::-webkit-scrollbar {
      width: 8px;
    }

    #gridContainer::-webkit-scrollbar-track {
      background: #1a1a1a;
    }

    #gridContainer::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 4px;
    }

    .filter-input {
      width: 100%;
      padding: 10px 12px;
      margin-bottom: 15px;
      box-sizing: border-box;
      border: 1px solid #444;
      border-radius: 6px;
      background: #2a2a2a;
      color: #e0e0e0;
      font-family: inherit;
      font-size: 14px;
    }

    .filter-input:focus {
      outline: none;
      border-color: #60a5fa;
    }

    .grid-item {
      padding: 10px 15px;
      cursor: pointer;
      background: #2a2a2a;
      border-radius: 4px;
      transition: all 0.2s;
      font-size: 14px;
    }

    .grid-item:hover {
      background: #333;
      color: #60a5fa;
    }

    .grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 8px;
    }

    .footer-info {
      position: fixed;
      bottom: 15px;
      right: 15px;
      font-size: 12px;
      color: #666;
      display: flex;
      gap: 15px;
    }

    @media (max-width: 768px) {
      #headerSection {
        flex-direction: column;
      }

      .tracker-selector {
        max-width: 100%;
      }

      .grid-container {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      }
    }
  </style>
</head>
<body>
  <button id="settingsToggle" aria-label="Settings" title="Settings">⚙</button>
  <form id="routeContainer">
    <div id="settingsMenu">
      <div class="setting">
        <label for="maxJumps">Max Jumps</label>
        <input type="number" id="maxJumps" value="5" min="1">
      </div>
      
      <div class="setting">
        <label for="maxDays">Max Days</label>
        <input type="number" id="maxDays" value="1080" min="1">
      </div>
      
      <div class="setting">
        <label for="sortOption">Sort By</label>
        <select id="sortOption">
          <option value="fastest">Fastest Route</option>
          <option value="fewestJumps">Least Jumps</option>
        </select>
      </div>
    </div>
    
    <div id="calcForm">
      <div id="headerSection">
        <div class="tracker-selector" id="sourceSelector">
          <div class="tracker-label">From</div>
          <div class="tracker-name" id="source">Any</div>
          <div class="tracker-abbr" id="sourceAbbr"></div>
        </div>
        
        <div class="nav-arrows">
          <div class="nav-arrow" id="prevroute">‹‹</div>
          <div class="nav-arrow" id="nextroute">››</div>
        </div>
        
        <div class="tracker-selector" id="targetSelector">
          <div class="tracker-label">To</div>
          <div class="tracker-name" id="target">Any</div>
          <div class="tracker-abbr" id="targetAbbr"></div>
        </div>
      </div>
      
      <div id="routeChain"></div>
      <div id="chainInfo"></div>
      <div id="detailsTable"></div>
    </div>
  </form>
  
  <div id="gridContainer"></div>
  
  <div class="footer-info">
    <span id="update-time">Loading...</span>
    <a href="https://www.reddit.com/r/TrackersInfo/wiki/official_recruitments/">TrackersInfo</a>
    <a href="https://github.com/ti-or/ti-or.github.io">GitHub</a>
  </div>

  <script>
    window.addEventListener('load', async function() {
      let data;
      try {
        const response = await fetch('trackers.json');
        data = await response.json();
      } catch (error) {
        console.error('Error loading trackers.json:', error);
        return;
      }

      const settingsMenu = document.getElementById('settingsMenu');
      const maxJumpsInput = document.getElementById('maxJumps');
      const maxDaysInput = document.getElementById('maxDays');
      const sortOption = document.getElementById('sortOption');
      const settingsToggle = document.getElementById('settingsToggle');
      let maxJumps = parseInt(localStorage.getItem('maxJumps'), 10) || 5;
      let maxDays = parseInt(localStorage.getItem('maxDays'), 10) || 1080;
      let sortOptionValue = localStorage.getItem('sortOption') || 'fastest';

      maxJumpsInput.value = maxJumps;
      maxDaysInput.value = maxDays;
      sortOption.value = sortOptionValue;

      calculateRoute();
      
      maxJumpsInput.addEventListener('change', (event) => {
        maxJumps = parseInt(event.target.value, 10);
        localStorage.setItem('maxJumps', maxJumps);
        calculateRoute();
      });

      maxDaysInput.addEventListener('change', (event) => {
        maxDays = parseInt(event.target.value, 10);
        localStorage.setItem('maxDays', maxDays);
        calculateRoute();
      });

      sortOption.addEventListener('change', () => {
        localStorage.setItem('sortOption', sortOption.value);
        calculateRoute();
      });
      
      settingsToggle.addEventListener('click', (event) => {
        event.stopPropagation();
        settingsMenu.style.display = settingsMenu.style.display === 'block' ? 'none' : 'block';
      });

      document.addEventListener('click', (event) => {
        if (!settingsMenu.contains(event.target) && event.target !== settingsToggle) {
          settingsMenu.style.display = 'none';
        }
      });

      const { routeInfo, unlockInviteClass, abbrList } = data;

      document.getElementById('sourceSelector').addEventListener('click', () => {
        toggleGrid('source');
      });

      document.getElementById('targetSelector').addEventListener('click', () => {
        toggleGrid('target');
      });

      document.getElementById('prevroute').addEventListener('click', () => {
        showRoute(-1);
      });

      document.getElementById('nextroute').addEventListener('click', () => {
        showRoute(1);
      });
      
      document.addEventListener('click', (event) => {
        const gridContainer = document.getElementById('gridContainer');
        if (gridContainer.style.display === 'block' && !gridContainer.contains(event.target) && 
            !event.target.closest('#sourceSelector') && !event.target.closest('#targetSelector')) {
          gridContainer.style.display = 'none';
        }
      });

      const apiUrl = `https://api.github.com/repos/ti-or/ti-or.github.io/commits?path=trackers.json`;

      fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
          const commitDate = data[0].commit.committer.date;
          const updateDate = new Date(commitDate).toLocaleDateString();
          document.getElementById('update-time').innerText = `Updated ${updateDate}`;
        })
        .catch(error => {
          console.error('Error fetching commit data:', error);
          document.getElementById('update-time').innerText = 'Update date unavailable';
        });

      let allRoutes = [];
      let currentRouteIndex = 0;

      function toggleGrid(buttonId) {
        const gridContainer = document.getElementById('gridContainer');
        if (gridContainer.style.display === 'none' || gridContainer.style.display === '') {
          populateGrid(buttonId);
          gridContainer.style.display = 'block';
        } else {
          gridContainer.style.display = 'none';
        }
      }

      function populateGrid(buttonId) {
        const gridContainer = document.getElementById('gridContainer');
        gridContainer.innerHTML = '';

        const uniqueKeys = Array.from(new Set(
          Object.keys(routeInfo)
          .flatMap(startKey => [startKey, ...Object.keys(routeInfo[startKey])])
        ))
        .sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));

        if (buttonId === 'source') uniqueKeys.unshift('Any');
        if (buttonId === 'target') uniqueKeys.unshift('Any');

        const abbrToNameMap = Object.keys(abbrList).reduce((map, name) => {
          map[abbrList[name].toLowerCase()] = name.toLowerCase();
          return map;
        }, {});

        const container = document.createElement('div');
        container.className = 'grid-container';

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'filter-input';
        input.placeholder = 'Search trackers...';
        container.appendChild(input);

        function updateItems(filterText = '') {
          const filterTextLower = filterText.toLowerCase();
          const filteredKeys = uniqueKeys.filter(key => {
            const keyLower = key.toLowerCase();
            return keyLower.includes(filterTextLower) || 
                   Object.keys(abbrToNameMap).some(abbr => 
                     abbr.includes(filterTextLower) && abbrToNameMap[abbr].includes(keyLower)
                   );
          });

          container.querySelectorAll('.grid-item').forEach(item => item.remove());

          filteredKeys.forEach(key => {
            const item = document.createElement('div');
            item.textContent = key;
            item.className = 'grid-item';
            item.addEventListener('click', () => {
              if (buttonId === 'source') {
                setTextContent('source', key);
                setTextContent('sourceAbbr', key === 'Any' ? '' : abbrList[key] || '');
              } else {
                setTextContent('target', key);
                setTextContent('targetAbbr', key === 'Any' ? '' : abbrList[key] || '');
              }
              gridContainer.style.display = 'none';
              calculateRoute();
            });
            container.appendChild(item);
          });
        }

        updateItems();

        input.addEventListener('input', (event) => {
          updateItems(event.target.value);
        });

        gridContainer.appendChild(container);
      }

      function calculateRoute() {
        const resultTitle = document.getElementById('routeChain');
        const resultDescription = document.getElementById('detailsTable');
        const resultFooter = document.getElementById('chainInfo');

        resultTitle.innerText = '';
        resultDescription.innerHTML = '';
        resultFooter.innerHTML = '';

        const start = document.getElementById('source').textContent.trim();
        const end = document.getElementById('target').textContent.trim();

        if (start === end && start !== 'Any') {
          resultTitle.innerText = 'One account per lifetime!';
          return;
        }

        if (start === 'Any') {
          if (end === 'Any') {
            resultTitle.innerText = 'Select source and target trackers';
            return;
          }
          allRoutes = Object.keys(routeInfo)
            .filter(node => routeInfo[node] && routeInfo[node][end])
            .map(node => [node, end]);
        } else if (end === 'Any') {
          if (!routeInfo[start]) {
            resultTitle.innerText = 'No official recruitment';
            return;
          }
          allRoutes = Object.keys(routeInfo[start])
            .map(node => [start, node])
            .filter(([from, to]) => routeInfo[from] && routeInfo[from][to]);
        } else {
          if (!routeInfo[start]) {
            resultTitle.innerText = 'No official recruitment';
            return;
          }
          allRoutes = findAllRoutes(start, end, maxJumps, maxDays);
        }

        if (allRoutes.length === 0) {
          resultTitle.innerText = 'No routes found';
          return;
        }

        if (sortOption.value === 'fastest') {
          allRoutes = allRoutes.sort((a, b) => {
            const timeA = calculateRouteDays(a);
            const timeB = calculateRouteDays(b);
            if (timeA !== timeB) return timeA - timeB;
            return a.length - b.length;
          });
        } else if (sortOption.value === 'fewestJumps') {
          allRoutes = allRoutes.sort((a, b) => {
            if (a.length !== b.length) return a.length - b.length;
            return calculateRouteDays(a) - calculateRouteDays(b);
          });
        }

        currentRouteIndex = 0;
        showRoute(0);
      }

      function calculateRouteDays(route) {
        return route.reduce((sum, node, index) => {
          if (index < route.length - 1 && routeInfo[node] && routeInfo[node][route[index + 1]]) {
            return sum + getMaxDays(node, route[index + 1]);
          }
          return sum;
        }, 0);
      }

      function findAllRoutes(start, end, maxJumps = 5, maxDays = 1080) {
        const result = [];
        const stack = [[start, [start], 0]];

        while (stack.length) {
          const [node, route, days] = stack.pop();
          
          if (route.length > maxJumps + 1) continue;

          if (node === end) {
            result.push(route);
            continue;
          }

          for (const [next, _] of Object.entries(routeInfo[node] || {})) {
            if (!route.includes(next)) {
              const maxDaysToNext = getMaxDays(node, next);
              // Allow routes with null/unknown days to be explored
              if (maxDaysToNext === null || maxDaysToNext === 0 || (days + maxDaysToNext) <= maxDays) {
                const newDays = maxDaysToNext === null ? days : days + maxDaysToNext;
                stack.push([next, [...route, next], newDays]);
              }
            }
          }
        }

        return result;
      }

      function showRoute(direction) {
        if (allRoutes.length === 0) return;

        currentRouteIndex = (currentRouteIndex + direction + allRoutes.length) % allRoutes.length;
        const route = allRoutes[currentRouteIndex];
        const resultTitle = document.getElementById('routeChain');
        const resultDescription = document.getElementById('detailsTable');
        const chainInfo = document.getElementById('chainInfo');

        function getAbbreviation(name) {
          return abbrList[name] || name;
        }

        const abbreviatedRoute = route.map(node => getAbbreviation(node));
        const displayRoute = abbreviatedRoute.join(' → ');

        resultTitle.innerText = displayRoute;
        
        const totalDays = calculateRouteDays(route);
        
        const details = route.map((node, index) => {
          if (index < route.length - 1 && routeInfo[node] && routeInfo[node][route[index + 1]]) {
            const nextNode = route[index + 1];
            const maxDays = getMaxDays(node, nextNode);
            const routeData = routeInfo[node][nextNode];
            const requirement = routeData.reqs || 'No requirement';
            const lastActivity = routeData.updated || 'Unknown';
            const daysDisplay = maxDays === null ? 'Unknown' : `${maxDays} days`;

            return `
              <div class="route-step">
                <div class="route-step-header">
                  <span>${node} → ${nextNode}</span>
                  <span class="route-step-days">${daysDisplay}</span>
                </div>
                <div class="route-step-row">
                  <div class="route-step-label">Class for invite forum</div>
                  <div class="route-step-value">${unlockInviteClass[node] ? unlockInviteClass[node][1] : 'N/A'}</div>
                </div>
                <div class="route-step-row">
                  <div class="route-step-label">Requirements</div>
                  <div class="route-step-value">${requirement}</div>
                </div>
                <div class="route-step-row">
                  <div class="route-step-label">Last checked</div>
                  <div class="route-step-value">${lastActivity}</div>
                </div>
              </div>
            `;
          }
          return '';
        }).join('');
        
        chainInfo.innerHTML = `
          <span>Route ${currentRouteIndex + 1} of ${allRoutes.length}</span>
          <span>Total: ${route.length - 1} Jump(s), ${totalDays} Day(s)</span>
        `;
        
        resultDescription.innerHTML = details;
      }

      function setTextContent(id, text) {
        document.getElementById(id).textContent = text;
      }

      function getMaxDays(start, end) {
        const routeData = routeInfo[start] && routeInfo[start][end];
        const days1 = routeData && routeData.days !== undefined ? routeData.days : null;
        const days2 = (unlockInviteClass[start] && unlockInviteClass[start][0]) || 0;

        // If days1 is null (unknown), return null so we can handle it separately
        if (days1 === null) return null;
        
        return Math.max(days1, days2);
      }
    });
  </script>
</body>
</html>
